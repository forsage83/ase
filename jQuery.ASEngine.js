/* ------------------------------------------------------------------------
 Aura Slider Engine ( https://github.com/mrgambal/ase )

 Simple, lightweight and flexible slider engine based on css animation abilities.
 Destination of this slider (and it major advantage) - just to change classes
 on items inside container. You could use all awailable css-powers to realize
 slider-effect of your dreams.

 Authors: JS-jedi: Dmitry Gambal ( https://github.com/mrgambal )
          CSS-jedi: Dmitry Nechepurenko ( https://github.com/dimanech )

 Inspired By: My Friend Dmitry Nechepurenko and some existing solutions

 Dependencies: jQuery >= 1.7.2
               jQuery Mobile (if you want to handle swipe events on mobile devices)

 Version: 0.7a

 Copyright: Feel free to redistribute the script/modify it, as
 long as you leave my info at the top.

 ------------------------------------------------------------------------- */
;
(function ($) {
    /*
	 * Creates new ASE object
	 * 
	 * @private
	 * @constructor
	 * @this {ASEngine}
	 * @see <init>
	 * 
     * @param {Object} opts Options set.
     * @param {jQuery} container jQuery-wrapped container for items.
     */
    function ASEngine(opts, container) {
        this.init(opts, container);
    }

    ASEngine.prototype = {
        /** @private {jQuery} Items container. */ 
		__container: null,
        /** @private {jQuery} Currently selected item. */
		__current: null,
        /** @private {Number} Currently selected item index. */ 
		__curIndex: null,
        /** @private {String} Events namespace name with leading dot. */ 
		__eventNS: '.ASEngine',
        /** @private {Number} Current ASE-instance index in window.ASESliders array. */ 
		__indexInArray: 0,
        /** @private  {String} Class-name for autogenerated pagination links 
		 *			w/o leading dot. 
		 */ 
		__pgnClass: 'js-ase__pagination__item',
        /** @private {jQuery} Pagination controls container. */ 
		__pgnContainer: null,
        /** @private {Number} Timer ID for autoplay. */ 
		__timerID: 0,

		/** {jQuery} Slider items list. */
        items: null,
		/** {Object} Options set. */
        options: {},
		/** {Object} Default options set. */
        defaultOptions: {
			/** {String} Default selector for items */
            itemsSelector: '.js-ase__item',
			/** {jQuery} 'Go to prev slide'-control. */
            prevCtrl: null,
			/** {jQuery} 'Go to next slide'-control. */
            nextCtrl: null,
			/** {jQuery} 'Swipe for next slide'-control. */
            swipeCtrl: null,
			/** {String} Default classname for next slide (w/o leading dot). */
            nextClass: 'js-ase__item_next',
			/** {String} Default classname for current slide (w/o leading dot). */		
            currentClass: 'js-ase__item_active',
			/** {String} Default classname for previous slide (w/o leading dot). */
            prevClass: 'js-ase__item_prev',
			/** {Function | null} Default callback for any slider move. */
            onMove: function () {},
			/** {Function | null} Default callback that executes on slide-to-next change. */
            onNext: function () {},
			/** {Function | null} Default callback that executes on slide-to-prev change. */
            onPrev: function () {},
			/** {Boolean} Flag to activate built-in autoplay functionality. */
            autoplay: false,
			/** {Number} Delay in milliseconds between automatic slide change. */
            autoplayDelay: 15000
        },
	    /*
		 * Defines all events handlers
		 * 
		 * @private
		 * @this {ASEngine} Current ASE instance.
		 * @see <init>
		 * 
		 * @return {ASEngine} Current ASE instance.
		 */
        __addEventHandlers: function () {
            var _s = this,
                _so = _s.options,
                hasHref = function (el) {
                    var href = el.href || (el.attributes.hasOwnProperty('data-href') ? el.attributes['data-href'].value : '');
                    return (href !== "" & (href !== location.href & href.indexOf(location.href + '#') < 0));
                },
                _p = function (e) {
                    if (hasHref(this))
                        return;

                    e.preventDefault();
                    _s.goPrev.call(_s, true);
                },
                _n = function (e) {
                    if (hasHref(this))
                        return;

                    e.preventDefault();
                    _s.goNext.call(_s, true);
                };

            // previous
            if (_so.prevCtrl && _so.prevCtrl.length)
                _so.prevCtrl.on('click' + _s.__eventNS, _p);
            // next
            if (_so.nextCtrl && _so.nextCtrl.length)
                _so.nextCtrl.on('click' + _s.__eventNS, _n);
            // autoplay
            if (_so.autoplay)
                _s.setAutoplay();
            else
                _s.stopAutoplay();
            // swipes on mobile devices
            if (_so.swipeCtrl && _so.swipeCtrl.length)
                _so.swipeCtrl.on('swipeleft' + _s.__eventNS, _n)
                    .on('swiperight' + _s.__eventNS, _p);
            // hover on container
            _s.__container
                .on('mouseenter' + _s.__eventNS, function () {
                    if (_s.__timerID)
                        clearInterval(_s.__timerID);
                })
                .on('mouseleave' + _s.__eventNS, function () {
                    if (_so.autoplay)
                        _s.setAutoplay.call(_s);
                });

            return _s;
        },
	    /*
		 * Changes look-and-feel for pagination links on click over them.
		 * 
		 * @private
		 * @this {ASEngine} Current ASE instance.
		 * @see <addPagination>
		 * 
		 * @param {Number} nextIndex Next slide index.
		 * @param {Number} prevIndex Previous slide index.
		 * 
		 * @return {ASEngine} Current ASE instance.
		 */
        __changePaginationLink: function (nextIndex, prevIndex) {
            var _s = this,
                actClass = _s.__pgnClass + '_active';

            nextIndex++;
            prevIndex++;

            _s.__pgnContainer
                .find('.' + actClass)
                .removeClass(actClass);
            _s.__pgnContainer
                .removeClass(_s.__pgnClass + '_p' + prevIndex)
                .addClass(_s.__pgnClass + '_p' + nextIndex)
                .find('a[data-href=#' + nextIndex + ']')[0]
                .className += ' ' + actClass;

            return _s;
        },
		/*
		 * Next slide index calculation.
		 * 
		 * @private
		 * @this {ASEngine} Current ASE instance.
		 * @see <goTo>
		 * 
		 * @param {Number} itemIndex Next slide index. May be greater than items count or less than 0.
		 * @param {Boolean} dontChange Stops __curIndex change through calculation.
		 * 
		 * @return {ASEngine} Current ASE instance.
		 */
        __nextIndex: function (itemIndex, dontChange) {
            var _s = this;
            // next index calculation
            if (itemIndex === _s.__curIndex)
                return 0;
            if (itemIndex > _s.items.length - 1) {
                if (!dontChange)
                    _s.__curIndex = -1;

                itemIndex = 0;
            } else if (itemIndex < 0) {
                if (!dontChange)
                    _s.__curIndex = _s.items.length;

                itemIndex = _s.items.length - 1;
            }

            return itemIndex;
        },
	    /*
		 * Removes all events handlers.
		 * 
		 * @private
		 * @this {ASEngine} Current ASE instance.
		 * @see <init>
		 * 
		 * @return {ASEngine} Current ASE instance.
		 */
        __removeEventHandlers: function () {
            var _s = this,
                _so = _s.options;

            if (_so.prevCtrl && _so.prevCtrl.length)
                _so.prevCtrl.off(_s.__eventNS);
            if (_so.nextCtrl && _so.nextCtrl.length)
                _so.nextCtrl.off(_s.__eventNS);
            if (_so.swipeCtrl && _so.swipeCtrl.length)
                _so.swipeCtrl.off(_s.__eventNS);
            if (_s.__pgnContainer)
                _s.__pgnContainer.find('.' + _s.__pgnClass).off(_s.__eventNS);
            _s.__container.off(_s.__eventNS);

            return _s;
        },
		/*
		 * Built-in autoplay functionality initialization.
		 * 
		 * @this {ASEngine} Current ASE instance.
		 * 
		 * @param {jQuery-object | String} container jQuery-selected container for pagination controls 
		 *			or selector for that container;
		 * @param {String | Boolean} pgnClass Class for pagination controls explicitly declared in your HTML-markup 
		 *			inside container specified by first parameter. Default value - 'js-ase__pagination';
		 * @param {String} addClass Class that will be added to pagination controls, only if they will be 
		 *			generated automatically. Default value - null.
		 *		
		 * @return {ASEngine} Current ASE instance.
		 */
        addPagination: function (container, pgnClass, addClass) {
            if (!container.hasOwnProperty("selector"))
                container = $(container);
            if (!container.length)
                return false;

            var _s = this,
                _h = function (e) {
                    var nextIndex = this.attributes['data-href'].value.substr(this.attributes['data-href'].value.indexOf('#') + 1) - 1,
                        fnName = (nextIndex < _s.__curIndex) ? 'onPrev' : 'onNext';

                    e.preventDefault();

                    if (typeof _s.options[fnName] === 'function')
                        _s.options[fnName].call(_s);

                    _s.goTo(nextIndex, true);
                };

            if (pgnClass && pgnClass.length)
                _s.__pgnClass = pgnClass;
            if (!container.find('.' + _s.__pgnClass).length)
                for (var i = 0; i++ < _s.items.length;)
                    container[0].innerHTML += (i === _s.__curIndex + 1)
                        ? ["<a data-href='#", i, "' class='", _s.__pgnClass, " ", (_s.__pgnClass + '_active'), " ", (addClass || ''), "'>", "</a>"].join("")
                        : ["<a data-href='#", i, "' class='", _s.__pgnClass, " ", (addClass || ''), "'>", "</a>"].join("");

            container[0].className += " " + _s.__pgnClass + "_p" + (_s.__curIndex + 1);
            _s.__pgnContainer = container.on('click' + _s.__eventNS, "." + _s.__pgnClass, _h);

            return _s;
        },
		/*
		 * Moves slider to the next slide.
		 * 
		 * @this {ASEngine} Current ASE instance.
		 * @see <goTo>
		 * 
		 * @param {Boolean} stopAutoplay Allows stop autoplay if enabled.
		 *		
		 * @return {ASEngine} Current ASE instance.
		 */
        goNext: function (stopAutoplay) {
            if (typeof this.options.onNext === 'function')
                this.options.onNext.call(this);

            return this.goTo(this.__curIndex + 1, stopAutoplay);
        },
		/*
		 * Moves slider to the previous slide.
		 * 
		 * @this {ASEngine} Current ASE instance.
		 * @see <goTo>
		 * 
		 * @param {Boolean} stopAutoplay Allows stop autoplay if enabled.
		 *		
		 * @return {ASEngine} Current ASE instance.
		 */
        goPrev: function (stopAutoplay) {
            if (typeof this.options.onPrev === 'function')
                this.options.onPrev.call(this);

            return this.goTo(this.__curIndex - 1, stopAutoplay);
        },
		/*
		 * Moves slider to specified slide.
		 * 
		 * @this {ASEngine} Current ASE instance.
		 * 
		 * @param {Number} itemIndex Target slide index. May be recalculated, if out of bounds.
		 * @param {Boolean} stopAutoplay Allows stop autoplay if enabled.
		 *		
		 * @return {ASEngine} Current ASE instance.
		 */
        goTo: function (itemIndex, stopAutoplay) {
            if (itemIndex === this.__curIndex) return this;

            var _s = this,
                _so = _s.options,
                goBack = false,
                nextIndex = 0,
                prevIndex = _s.__curIndex;

            itemIndex = _s.__nextIndex(itemIndex);
            goBack = itemIndex < _s.__curIndex;
            // calculate prev and next index
            if (Math.abs(itemIndex - _s.__curIndex) > 1)
                prevIndex = _s.__nextIndex((goBack ? itemIndex + 1 : itemIndex - 1), true);
            nextIndex = _s.__nextIndex((goBack ? itemIndex - 1 : itemIndex + 1), true);
            // pagination links update
            if (_s.__pgnContainer)
                _s.__changePaginationLink(itemIndex, prevIndex);
            // disable autoplay
            if (stopAutoplay)
                _s.stopAutoplay();

            // clear classes and add to prev/next class to destination item
            _s.items
                .removeClass(_so.prevClass + " " + _so.nextClass)[itemIndex]
                .className += " " + (goBack ? _so.prevClass : _so.nextClass);
            // clear current class
            _s.__current
                .removeClass(_so.currentClass);
            // add class to prev item
            _s.items[prevIndex]
                .className += " " + (goBack ? _so.nextClass : _so.prevClass);
            // set current item and add needed class
            _s.__current = _s.items.eq(itemIndex)
                .removeClass(goBack ? _so.prevClass : _so.nextClass)
                .addClass(_so.currentClass);
            // add class to next item
            _s.items[nextIndex]
                .className += " " + (goBack ? _so.prevClass : _so.nextClass);
            _s.__curIndex = itemIndex;
            // call onMove
            if (typeof _so.onMove === 'function')
                _so.onMove.call(this);

            return _s;
        },
		/*
		 * Enables autoslide using timeouts with specified or default delay.
		 * 
		 * @this {ASEngine} Current ASE instance.
		 * 
		 * @param {Number} interval Delay in milliseconds between automatic slide change.
		 *		
		 * @return {ASEngine} Current ASE instance.
		 */
        setAutoplay: function (interval) {
            var _s = this;

            if ((interval = parseInt(interval)))
                _s.options.autoplayDelay = interval;

            _s.stopAutoplay()
              .__timerID = setInterval(function () {
                _s.goNext(false);
            }, _s.options.autoplayDelay);

            _s.options.autoplay = true;

            return _s;
        },
		/*
		 * Disables autoslide if enabled.
		 * 
		 * @this {ASEngine} Current ASE instance.
		 *		
		 * @return {ASEngine} Current ASE instance.
		 */
        stopAutoplay: function () {
            var _s = this;

            if (_s.__timerID) {
                clearInterval(_s.__timerID);
                _s.__timerID = _s.options.autoplay = false;
            }

            return _s;
        },
		/*
		 * Initializes new ASE-object state
		 * 
		 * @this {ASEngine}
		 * 
		 * @param {Object} opts Options set.
		 * @param {jQuery} container jQuery-wrapped container.
         *
         * @return {ASEngine} Current ASE instance.
		 */
        init: function (opts, container) {
            var _s = this;

            // try to find existing ASE binding
            _old = (_s.__container || container).data('ASEngine');
            // apply options
            _s.options = $.extend({}, (_old ? _old.options : _s.defaultOptions), opts);
            _s.items = (_s.__container = _s.__container || container).find(_s.options.itemsSelector);

            if (_s.items.length < 3)
                return false;

            _s.__current = _s.items.first().addClass(_s.options.currentClass);
            _s.items[1].className += ' ' + _s.options.nextClass;
            _s.items[_s.items.length - 1].className += ' ' + _s.options.prevClass;

            _s.__curIndex = 0;
            _s.__removeEventHandlers()
                .__addEventHandlers();

            return _s;
        }
    };

	/*
	 * Aura Slider Engine main public function
	 * Initialize new ASE-object and bind it with pagecontext
	 * 
	 * @this {jQuery} Slides container.
	 * 
     * @param {Object} opts Options.
	 * 
	 * @return {ASEngine | Boolean} New ASE-instance or 'false' if something went wrong.
     */
    $.fn.ASE = function (opts) {
        var _s = new ASEngine(opts, this);

        _s.__indexInArray = (window.ASESliders = window.ASESliders || []).push(_s) - 1;
        this.data('ASEngine', _s);

        return _s;
    };
})(jQuery);
